---
phase: 04-observability-manual-sync
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - cmd/sync/main.go
  - go.mod
autonomous: true

must_haves:
  truths:
    - "User can run sync CLI command to re-index documentation"
    - "Sync clears existing collection before re-indexing"
    - "Sync shows progress output during operation"
    - "Sync reports success/failure counts upon completion"
    - "Sync reports failed document paths with error reasons"
  artifacts:
    - path: "cmd/sync/main.go"
      provides: "CLI sync command entry point"
      contains: "func main()"
      min_lines: 80
    - path: "go.mod"
      provides: "Cobra dependency"
      contains: "github.com/spf13/cobra"
  key_links:
    - from: "cmd/sync/main.go"
      to: "storage.ClearCollection"
      via: "collection reset before indexing"
      pattern: "ClearCollection"
    - from: "cmd/sync/main.go"
      to: "pipeline.IndexAll"
      via: "full indexing call"
      pattern: "IndexAll"
---

<objective>
Implement CLI sync command that re-indexes all EINO documentation from GitHub.

Purpose: Users can manually trigger a full re-index when documentation has been updated.
Output: Standalone CLI binary `eino-sync` with `sync` subcommand for documentation re-indexing.
</objective>

<execution_context>
@/home/bull/.claude/get-shit-done/workflows/execute-plan.md
@/home/bull/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-observability-manual-sync/04-CONTEXT.md
@.planning/phases/04-observability-manual-sync/04-RESEARCH.md
@internal/indexer/pipeline.go
@internal/storage/qdrant.go
@cmd/mcp-server/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Cobra dependency and create CLI structure</name>
  <files>go.mod, cmd/sync/main.go</files>
  <action>
Add Cobra dependency:
```bash
go get github.com/spf13/cobra@latest
```

Create cmd/sync/main.go with Cobra command structure:

```go
// Package main provides the sync CLI for EINO documentation indexing.
package main

import (
    "fmt"
    "os"

    "github.com/spf13/cobra"
)

var rootCmd = &cobra.Command{
    Use:   "eino-sync",
    Short: "EINO documentation indexing tool",
    Long:  "CLI tool for managing EINO documentation index in Qdrant",
}

var syncCmd = &cobra.Command{
    Use:   "sync",
    Short: "Re-index all documentation from GitHub",
    Long: `Clears existing index and rebuilds from latest GitHub commit.

This command:
1. Connects to Qdrant and verifies health
2. Clears the existing document collection
3. Fetches all EINO documentation from GitHub
4. Generates embeddings and metadata for each document
5. Stores documents and chunks in Qdrant

Environment variables:
  QDRANT_HOST    Qdrant hostname (default: localhost)
  QDRANT_PORT    Qdrant gRPC port (default: 6334)
  OPENAI_API_KEY OpenAI API key for embeddings (required)
  GITHUB_TOKEN   GitHub token for higher rate limits (optional)`,
    RunE: runSync,
}

func init() {
    rootCmd.AddCommand(syncCmd)
}

func main() {
    if err := rootCmd.Execute(); err != nil {
        os.Exit(1)
    }
}

func runSync(cmd *cobra.Command, args []string) error {
    // Placeholder - Task 2 implements this
    fmt.Println("Sync command placeholder")
    return nil
}
```

Verify structure compiles:
```bash
go build ./cmd/sync
```
  </action>
  <verify>
1. go mod tidy runs without errors
2. go build ./cmd/sync produces eino-sync binary
3. ./cmd/sync/eino-sync --help shows command help
  </verify>
  <done>Cobra dependency added, CLI structure with root and sync commands exists</done>
</task>

<task type="auto">
  <name>Task 2: Implement sync command with full pipeline</name>
  <files>cmd/sync/main.go</files>
  <action>
Implement the runSync function with full pipeline orchestration:

1. Print "Starting sync..." header
2. Initialize dependencies with progress output:
   - Qdrant storage (print "Connecting to Qdrant...")
   - Check health before proceeding (print "Qdrant healthy")
   - GitHub client
   - Embedding client (validates OPENAI_API_KEY)
   - Embedder
   - Metadata generator
   - Markdown chunker
   - Fetcher
3. Clear collection with progress output:
   - Print "Clearing existing collection..."
   - Call store.ClearCollection(ctx)
   - Print "Collection cleared"
4. Initialize pipeline and run indexing:
   - Print "Indexing documents from GitHub..."
   - Call pipeline.IndexAll(ctx)
5. Print results:
   ```
   Sync complete!
     Documents: {successful}/{total}
     Chunks: {chunks}
     Duration: {duration}
     Commit: {sha}
   ```
6. If any failed docs, print:
   ```
   Failed documents:
     - {path}: {reason}
   ```

Environment variable handling (reuse patterns from main.go):
```go
func getEnv(key, defaultValue string) string {
    if v := os.Getenv(key); v != "" {
        return v
    }
    return defaultValue
}

func getEnvInt(key string, defaultValue int) int {
    // Same as cmd/mcp-server/main.go
}
```

Default values:
- QDRANT_HOST: "localhost"
- QDRANT_PORT: 6334

Error handling:
- Qdrant connection failure: Exit with "Failed to connect to Qdrant: {error}"
- Health check failure: Exit with "Qdrant health check failed: {error}"
- Embedding client failure: Exit with "Failed to create embedding client: {error}"
- Clear collection failure: Exit with "Failed to clear collection: {error}"
- IndexAll failure: Exit with "Indexing failed: {error}"

Import the correct packages:
```go
import (
    "context"
    "fmt"
    "log"
    "os"

    "github.com/spf13/cobra"

    "github.com/bull/eino-mcp-server/internal/embedding"
    "github.com/bull/eino-mcp-server/internal/github"
    "github.com/bull/eino-mcp-server/internal/indexer"
    "github.com/bull/eino-mcp-server/internal/markdown"
    "github.com/bull/eino-mcp-server/internal/metadata"
    "github.com/bull/eino-mcp-server/internal/storage"
)
```
  </action>
  <verify>
1. go build ./cmd/sync succeeds
2. Run with Qdrant available but no OPENAI_API_KEY:
   ./cmd/sync/eino-sync sync
   Should fail with embedding client error (expected - validates pipeline init)
  </verify>
  <done>Sync command fully implemented with progress output, error handling, and result reporting</done>
</task>

</tasks>

<verification>
1. `go build ./cmd/sync` produces working binary
2. `./cmd/sync/eino-sync --help` shows root command help
3. `./cmd/sync/eino-sync sync --help` shows sync command help with env var docs
4. Running without OPENAI_API_KEY fails with clear error message
5. (With full environment) Full sync works end-to-end
</verification>

<success_criteria>
- CLI binary builds and runs
- `sync` subcommand clears collection and runs full indexing pipeline
- Progress output shows each stage (connecting, clearing, indexing)
- Final output shows success/failure counts, duration, commit SHA
- Failed documents listed with paths and error reasons
- Clear error messages for missing dependencies (Qdrant, OpenAI API key)
</success_criteria>

<output>
After completion, create `.planning/phases/04-observability-manual-sync/04-02-SUMMARY.md`
</output>
