---
phase: 05-deployment
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Application deploys to Fly.io without errors"
    - "Both MCP server and Qdrant processes are running"
    - "Health endpoint returns healthy status"
    - "Volume is mounted and Qdrant can persist data"
  artifacts: []
  key_links: []
---

<objective>
Deploy to Fly.io and verify production environment works correctly.

Purpose: Validate that all deployment configuration works together - Dockerfile builds, fly.toml is valid, processes start, health checks pass, and volume persistence works.

Output: Running application on Fly.io accessible at eino-docs-mcp.fly.dev
</objective>

<execution_context>
@/home/bull/.claude/get-shit-done/workflows/execute-plan.md
@/home/bull/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deployment/05-RESEARCH.md
@.planning/phases/05-deployment/05-CONTEXT.md
@Dockerfile
@fly.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Authenticate with Fly.io CLI</name>
  <files></files>
  <action>
Check if flyctl is installed and authenticated:

1. Check flyctl installation:
```bash
fly version || echo "flyctl not installed"
```

2. If not installed, provide instructions:
```bash
curl -L https://fly.io/install.sh | sh
```

3. Check authentication:
```bash
fly auth whoami
```

4. If not authenticated, authenticate (this will open browser):
```bash
fly auth login
```

Note: If authentication fails or is unavailable, create checkpoint for user to complete manually.
  </action>
  <verify>
`fly auth whoami` returns a valid user email
  </verify>
  <done>flyctl is installed and authenticated</done>
</task>

<task type="auto">
  <name>Task 2: Create Fly.io app and set secrets</name>
  <files></files>
  <action>
1. Launch the app (this creates the app on Fly.io without deploying):
```bash
fly apps create eino-docs-mcp --org personal
```

Note: If app name is taken, try with a suffix or let user choose.

2. Create the volume for Qdrant data:
```bash
fly volumes create qdrant_data --region iad --size 1 --yes
```

3. Prompt user for secrets (do NOT include actual values in plan):
```bash
# User must run these with their actual keys:
# fly secrets set OPENAI_API_KEY=sk-...
# fly secrets set GITHUB_TOKEN=ghp_...
```

Create a checkpoint here - secrets must be set by user before deploy.
  </action>
  <verify>
1. `fly apps list` shows eino-docs-mcp
2. `fly volumes list` shows qdrant_data volume
  </verify>
  <done>Fly.io app created with volume, ready for secrets</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set Fly.io secrets</action>
  <instructions>
The following secrets must be set before deployment. Run these commands with your actual API keys:

```bash
fly secrets set OPENAI_API_KEY=sk-your-openai-key-here
fly secrets set GITHUB_TOKEN=ghp_your-github-token-here
```

Verify secrets are set:
```bash
fly secrets list
```

You should see both OPENAI_API_KEY and GITHUB_TOKEN listed (values are hidden).
  </instructions>
  <resume-signal>Type "secrets set" when both secrets are configured</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Deploy to Fly.io</name>
  <files></files>
  <action>
Deploy the application:

```bash
fly deploy
```

This will:
1. Build the Docker image remotely
2. Push to Fly.io registry
3. Start both web and qdrant processes
4. Wait for health checks to pass

Monitor the deployment output for errors.
  </action>
  <verify>
1. `fly status` shows both processes running
2. Health check passes: `curl https://eino-docs-mcp.fly.dev/health`
  </verify>
  <done>Application deployed and health check passing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Fly.io deployment with:
- MCP server process serving health endpoint
- Qdrant process with persistent volume
- Public HTTPS access at eino-docs-mcp.fly.dev
  </what-built>
  <how-to-verify>
1. Check deployment status:
   ```bash
   fly status
   ```
   Both 'web' and 'qdrant' processes should show as 'running'

2. Test health endpoint:
   ```bash
   curl https://eino-docs-mcp.fly.dev/health
   ```
   Should return: {"status":"healthy","qdrant":"connected","timestamp":"..."}

3. Check logs for any errors:
   ```bash
   fly logs
   ```
   Look for successful startup messages, no errors

4. Verify volume is working:
   ```bash
   fly volumes list
   ```
   Should show qdrant_data volume attached to qdrant process

5. (Optional) Run initial sync to populate index:
   ```bash
   fly ssh console -s -C "/app/mcp-server sync"
   ```
   Or run sync locally with Fly.io secrets proxied.
  </how-to-verify>
  <resume-signal>Type "verified" if deployment is working, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `fly status` shows healthy deployment
2. `fly apps list` shows eino-docs-mcp
3. `curl https://eino-docs-mcp.fly.dev/health` returns healthy status
4. Fly.io dashboard shows both processes running
</verification>

<success_criteria>
- Application deployed to Fly.io
- Both MCP server and Qdrant processes running
- Health endpoint accessible at https://eino-docs-mcp.fly.dev/health
- Volume mounted for Qdrant persistence
- No deployment errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-deployment/05-04-SUMMARY.md`
</output>
